name: Deploy to DigitalOcean via Docker Hub

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

env:
  DOCKER_USERNAME: friendy21
  STRAPI_IMAGE: friendy21/strapi-starter-backend
  NEXTJS_IMAGE: friendy21/strapi-starter-frontend
  DEPLOY_PATH: /opt/strapi-app

jobs:
  build-and-push:
    name: Build and Push to Docker Hub
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Extract version tag
        id: meta
        run: |
          # Use commit SHA as tag
          echo "tag=sha-${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          echo "date=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT

      - name: Build and push Strapi image
        uses: docker/build-push-action@v5
        with:
          context: ./server
          file: ./server/Dockerfile
          push: true
          tags: |
            ${{ env.STRAPI_IMAGE }}:latest
            ${{ env.STRAPI_IMAGE }}:${{ steps.meta.outputs.tag }}
          cache-from: type=registry,ref=${{ env.STRAPI_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.STRAPI_IMAGE }}:buildcache,mode=max

      - name: Build and push Next.js image
        uses: docker/build-push-action@v5
        with:
          context: ./client
          file: ./client/Dockerfile
          push: true
          build-args: |
            NEXT_PUBLIC_STRAPI_URL=${{ secrets.NEXT_PUBLIC_STRAPI_URL }}
            STRAPI_BASE_URL=http://strapi:1337
          tags: |
            ${{ env.NEXTJS_IMAGE }}:latest
            ${{ env.NEXTJS_IMAGE }}:${{ steps.meta.outputs.tag }}
          cache-from: type=registry,ref=${{ env.NEXTJS_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.NEXTJS_IMAGE }}:buildcache,mode=max

      - name: Image build summary
        run: |
          echo "‚úÖ Images built and pushed successfully!"
          echo "Strapi: ${{ env.STRAPI_IMAGE }}:latest"
          echo "Next.js: ${{ env.NEXTJS_IMAGE }}:latest"
          echo "Tag: ${{ steps.meta.outputs.tag }}"

  deploy:
    name: Deploy to Droplet
    runs-on: ubuntu-latest
    needs: build-and-push
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DROPLET_SSH_KEY }}

      - name: Add Droplet to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.DROPLET_IP }} >> ~/.ssh/known_hosts

      - name: Copy docker-compose.prod.yml to Droplet
        env:
          DROPLET_IP: ${{ secrets.DROPLET_IP }}
          DROPLET_USER: ${{ secrets.DROPLET_USER }}
        run: |
          echo "üìÑ Copying docker-compose.prod.yml to Droplet..."
          scp docker-compose.prod.yml $DROPLET_USER@$DROPLET_IP:${{ env.DEPLOY_PATH }}/docker-compose.yml
          scp -r nginx $DROPLET_USER@$DROPLET_IP:${{ env.DEPLOY_PATH }}/ || echo "‚ö†Ô∏è nginx folder not found, skipping"

      - name: Setup Environment on Droplet
        env:
          DROPLET_IP: ${{ secrets.DROPLET_IP }}
          DROPLET_USER: ${{ secrets.DROPLET_USER }}
        run: |
          echo "üîß Setting up environment variables on Droplet..."
          ssh $DROPLET_USER@$DROPLET_IP 'bash -s' << 'ENDSSH'
            cd /opt/strapi-app
            
            # Only create .env if it doesn't exist (preserve existing secrets!)
            if [ ! -f .env ]; then
              echo "üîë Generating Strapi secrets for first deployment..."
              
              # Generate secure random secrets
              JWT_SECRET=$(openssl rand -base64 32)
              ADMIN_JWT_SECRET=$(openssl rand -base64 32)
              APP_KEY1=$(openssl rand -base64 32)
              APP_KEY2=$(openssl rand -base64 32)
              APP_KEY3=$(openssl rand -base64 32)
              APP_KEY4=$(openssl rand -base64 32)
              API_TOKEN_SALT=$(openssl rand -base64 32)
              TRANSFER_TOKEN_SALT=$(openssl rand -base64 32)
              DB_PASSWORD=$(openssl rand -base64 16 | tr -d '/+=' | head -c 16)
              
              # Create .env file
              echo "# Auto-generated Strapi production secrets" > .env
              echo "DATABASE_USERNAME=strapi" >> .env
              echo "DATABASE_PASSWORD=${DB_PASSWORD}" >> .env
              echo "DATABASE_NAME=strapi" >> .env
              echo "" >> .env
              echo "JWT_SECRET=${JWT_SECRET}" >> .env
              echo "ADMIN_JWT_SECRET=${ADMIN_JWT_SECRET}" >> .env
              echo "APP_KEYS=${APP_KEY1},${APP_KEY2},${APP_KEY3},${APP_KEY4}" >> .env
              echo "API_TOKEN_SALT=${API_TOKEN_SALT}" >> .env
              echo "TRANSFER_TOKEN_SALT=${TRANSFER_TOKEN_SALT}" >> .env
              echo "" >> .env
              echo "NEXT_PUBLIC_STRAPI_URL=http://$(curl -s ifconfig.me)" >> .env
              
              echo "‚úÖ .env file created with new secrets"
            else
              echo "‚ÑπÔ∏è .env file exists - keeping existing secrets for database persistence"
            fi
          ENDSSH

      - name: Deploy to Droplet
        env:
          DROPLET_IP: ${{ secrets.DROPLET_IP }}
          DROPLET_USER: ${{ secrets.DROPLET_USER }}
          DOCKER_USERNAME: ${{ env.DOCKER_USERNAME }}
        run: |
          ssh $DROPLET_USER@$DROPLET_IP << 'ENDSSH'
            set -e
            
            echo "üöÄ Starting deployment..."
            
            # Navigate to app directory
            cd ${{ env.DEPLOY_PATH }}
            
            # Create directories if they don't exist
            mkdir -p /opt/backups
            
            # Backup database before deployment
            echo "üíæ Creating database backup..."
            docker exec strapi-postgres pg_dump -U strapi strapi > /opt/backups/pre-deploy-$(date +%Y%m%d_%H%M%S).sql || echo "‚ö†Ô∏è Backup failed, continuing..."
            
            # Login to Docker Hub
            echo "üîê Logging into Docker Hub..."
            echo "${{ secrets.DOCKER_HUB_TOKEN }}" | docker login -u ${{ env.DOCKER_USERNAME }} --password-stdin
            
            # Pull latest images from Docker Hub
            echo "üì¶ Pulling latest images from Docker Hub..."
            docker pull ${{ env.STRAPI_IMAGE }}:latest
            docker pull ${{ env.NEXTJS_IMAGE }}:latest
            
            # COMPLETE DATABASE RESET - Stop everything first
            echo "üîÑ Complete database reset - stopping all containers..."
            docker-compose down || true
            
            # Delete .env to force regeneration with fresh credentials
            echo "üóëÔ∏è Deleting old .env file..."
            rm -f .env
            
            # Remove ALL volumes to ensure fresh database
            echo "üóëÔ∏è Removing all Docker volumes..."
            docker volume rm strapi-app_postgres_data 2>/dev/null || true
            docker volume rm strapi-app_strapi_uploads 2>/dev/null || true
            
            # Stop any existing nginx/apache using port 80
            echo "üîå Freeing up ports..."
            sudo systemctl stop nginx 2>/dev/null || true
            sudo systemctl stop apache2 2>/dev/null || true
            sudo fuser -k 80/tcp 2>/dev/null || true
            sudo fuser -k 443/tcp 2>/dev/null || true
            sudo fuser -k 8080/tcp 2>/dev/null || true
            
            # Start services with new images (uses docker-compose.yml which is docker-compose.prod.yml)
            echo "üöÄ Starting services with Docker Hub images..."
            docker-compose up -d
            
            # Wait for PostgreSQL to be ready first
            echo "‚è≥ Waiting for PostgreSQL to start..."
            sleep 15
            
            # Show container status
            echo "üìä Container status after 15 seconds:"
            docker-compose ps
            
            # Show Strapi logs
            echo "üìã Strapi container logs:"
            docker-compose logs strapi || docker logs strapi-backend 2>/dev/null || echo "No strapi logs available"
            
            # Wait more for Strapi to initialize
            echo "‚è≥ Waiting 60 more seconds for Strapi to fully initialize..."
            sleep 60
            
            # Show final status
            echo "üìä Final container status:"
            docker-compose ps
            
            # Test database connection
            echo "üîç Testing database connection..."
            docker exec strapi-postgres pg_isready -U strapi || echo "‚ùå PostgreSQL not ready"
            
            # Show database credentials (masked password)
            echo "üîê Database credentials check:"
            docker exec strapi-backend printenv | grep DATABASE || echo "No DATABASE env vars found"
            
            # Try to connect from Strapi container to PostgreSQL
            echo "üîå Testing Strapi -> PostgreSQL connection..."
            docker exec strapi-backend sh -c 'nc -zv postgres 5432' || echo "‚ùå Cannot reach postgres:5432"
            
            
            # Show .env file (masked)
            echo "üìù Environment file exists and has content:"
            ls -la .env 2>/dev/null || echo "No .env file found!"
            
            # Check system resources
            echo "üíª System resources:"
            free -h
            df -h /
            
            # Check firewall status
            echo "üî• Firewall status:"
            sudo ufw status 2>/dev/null || echo "UFW not installed or not running"
            
            # Test internal connectivity
            echo "üîå Testing internal container connectivity:"
            docker exec strapi-nginx curl -s http://strapi:1337/admin 2>/dev/null && echo "‚úÖ Nginx can reach Strapi" || echo "‚ùå Nginx cannot reach Strapi"
            docker exec strapi-nginx curl -s http://nextjs:3000 2>/dev/null && echo "‚úÖ Nginx can reach Next.js" || echo "‚ùå Nginx cannot reach Next.js"
            
            # Check if services are running
            if docker-compose ps | grep -q "Up"; then
              echo "‚úÖ Containers are running"
              
              # Show Strapi logs again
              echo "üìã Final Strapi logs:"
              docker-compose logs --tail=50 strapi || docker logs --tail=50 strapi-backend 2>/dev/null
              
              # Test Strapi directly
              echo "üß™ Testing Strapi health endpoint:"
              curl -s http://localhost:1337/_health 2>/dev/null || echo "Strapi health check failed on localhost"
            else
              echo "‚ùå Deployment failed!"
              docker-compose logs
              exit 1
            fi
            
            # Clean up old Docker images
            echo "üßπ Cleaning up old images..."
            docker image prune -f
            
            # Logout from Docker Hub
            docker logout
            
            echo "üéâ Deployment complete!"
          ENDSSH

      - name: Verify Deployment
        env:
          DROPLET_IP: ${{ secrets.DROPLET_IP }}
        run: |
          echo "üîç Verifying deployment..."
          echo "‚è≥ Waiting 60 seconds for Strapi to fully initialize..."
          sleep 60
          
          # Check if frontend is accessible
          if curl -f -s -o /dev/null http://$DROPLET_IP; then
            echo "‚úÖ Frontend is accessible"
          else
            echo "‚ùå Frontend is not accessible"
            exit 1
          fi
          
          # Check if Strapi admin is accessible (with retry)
          echo "üîç Checking Strapi admin..."
          for i in 1 2 3; do
            if curl -f -s -o /dev/null http://$DROPLET_IP/admin; then
              echo "‚úÖ Strapi admin is accessible"
              exit 0
            fi
            echo "‚è≥ Strapi not ready yet, retrying in 20 seconds... (attempt $i/3)"
            sleep 20
          done
          echo "‚ö†Ô∏è Strapi admin check timed out - containers are running, admin may need more time to initialize"
          echo "Check manually at: http://$DROPLET_IP/admin"

      - name: Deployment Summary
        if: success()
        run: |
          echo "üéâ Deployment completed successfully!"
          echo "Images deployed:"
          echo "  - Strapi: ${{ env.STRAPI_IMAGE }}:latest"
          echo "  - Next.js: ${{ env.NEXTJS_IMAGE }}:latest"
          echo "Access your application at: http://${{ secrets.DROPLET_IP }}"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo "Check the logs above for details."

