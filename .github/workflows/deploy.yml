name: Deploy to DigitalOcean via Docker Hub

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

env:
  DOCKER_USERNAME: friendy21
  STRAPI_IMAGE: friendy21/strapi-starter-backend
  NEXTJS_IMAGE: friendy21/strapi-starter-frontend
  DEPLOY_PATH: /opt/strapi-app

jobs:
  build-and-push:
    name: Build and Push to Docker Hub
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Extract version tag
        id: meta
        run: |
          # Use commit SHA as tag
          echo "tag=sha-${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          echo "date=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT

      - name: Build and push Strapi image
        uses: docker/build-push-action@v5
        with:
          context: ./server
          file: ./server/Dockerfile
          push: true
          tags: |
            ${{ env.STRAPI_IMAGE }}:latest
            ${{ env.STRAPI_IMAGE }}:${{ steps.meta.outputs.tag }}
          cache-from: type=registry,ref=${{ env.STRAPI_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.STRAPI_IMAGE }}:buildcache,mode=max

      - name: Build and push Next.js image
        uses: docker/build-push-action@v5
        with:
          context: ./client
          file: ./client/Dockerfile
          push: true
          build-args: |
            NEXT_PUBLIC_STRAPI_URL=${{ secrets.NEXT_PUBLIC_STRAPI_URL }}
            STRAPI_BASE_URL=http://strapi:1337
          tags: |
            ${{ env.NEXTJS_IMAGE }}:latest
            ${{ env.NEXTJS_IMAGE }}:${{ steps.meta.outputs.tag }}
          cache-from: type=registry,ref=${{ env.NEXTJS_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.NEXTJS_IMAGE }}:buildcache,mode=max

      - name: Image build summary
        run: |
          echo "‚úÖ Images built and pushed successfully!"
          echo "Strapi: ${{ env.STRAPI_IMAGE }}:latest"
          echo "Next.js: ${{ env.NEXTJS_IMAGE }}:latest"
          echo "Tag: ${{ steps.meta.outputs.tag }}"

  deploy:
    name: Deploy to Droplet
    runs-on: ubuntu-latest
    needs: build-and-push
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DROPLET_SSH_KEY }}

      - name: Add Droplet to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.DROPLET_IP }} >> ~/.ssh/known_hosts

      - name: Copy docker-compose.prod.yml to Droplet
        env:
          DROPLET_IP: ${{ secrets.DROPLET_IP }}
          DROPLET_USER: ${{ secrets.DROPLET_USER }}
        run: |
          echo "üìÑ Copying docker-compose.prod.yml to Droplet..."
          scp docker-compose.prod.yml $DROPLET_USER@$DROPLET_IP:${{ env.DEPLOY_PATH }}/docker-compose.yml
          scp -r nginx $DROPLET_USER@$DROPLET_IP:${{ env.DEPLOY_PATH }}/ || echo "‚ö†Ô∏è nginx folder not found, skipping"

      - name: Setup Environment on Droplet
        env:
          DROPLET_IP: ${{ secrets.DROPLET_IP }}
          DROPLET_USER: ${{ secrets.DROPLET_USER }}
        run: |
          echo "üîß Setting up environment variables on Droplet..."
          ssh $DROPLET_USER@$DROPLET_IP 'bash -s' << 'ENDSSH'
            cd /opt/strapi-app
            
            # Always regenerate .env for clean deployment
            echo "üîë Generating fresh Strapi secrets..."
            
            # Generate secure random secrets
            JWT_SECRET=$(openssl rand -base64 32)
            ADMIN_JWT_SECRET=$(openssl rand -base64 32)
            APP_KEY1=$(openssl rand -base64 32)
            APP_KEY2=$(openssl rand -base64 32)
            APP_KEY3=$(openssl rand -base64 32)
            APP_KEY4=$(openssl rand -base64 32)
            API_TOKEN_SALT=$(openssl rand -base64 32)
            TRANSFER_TOKEN_SALT=$(openssl rand -base64 32)
            DB_PASSWORD=$(openssl rand -base64 16 | tr -d '/+=' | head -c 16)
            
            # Create fresh .env file
            echo "# Auto-generated Strapi production secrets" > .env
            echo "DATABASE_USERNAME=strapi" >> .env
            echo "DATABASE_PASSWORD=${DB_PASSWORD}" >> .env
            echo "DATABASE_NAME=strapi" >> .env
            echo "" >> .env
            echo "JWT_SECRET=${JWT_SECRET}" >> .env
            echo "ADMIN_JWT_SECRET=${ADMIN_JWT_SECRET}" >> .env
            echo "APP_KEYS=${APP_KEY1},${APP_KEY2},${APP_KEY3},${APP_KEY4}" >> .env
            echo "API_TOKEN_SALT=${API_TOKEN_SALT}" >> .env
            echo "TRANSFER_TOKEN_SALT=${TRANSFER_TOKEN_SALT}" >> .env
            echo "" >> .env
            echo "NEXT_PUBLIC_STRAPI_URL=http://$(curl -s ifconfig.me)" >> .env
            
            echo "‚úÖ Fresh .env file created with new secrets"
          ENDSSH

      - name: Deploy to Droplet
        env:
          DROPLET_IP: ${{ secrets.DROPLET_IP }}
          DROPLET_USER: ${{ secrets.DROPLET_USER }}
          DOCKER_USERNAME: ${{ env.DOCKER_USERNAME }}
        run: |
          ssh $DROPLET_USER@$DROPLET_IP << 'ENDSSH'
            set -e
            
            echo "üöÄ Starting deployment..."
            
            # Navigate to app directory
            cd ${{ env.DEPLOY_PATH }}
            
            # Create directories if they don't exist
            mkdir -p /opt/backups
            
            # Backup database before deployment
            echo "üíæ Creating database backup..."
            docker exec strapi-postgres pg_dump -U strapi strapi > /opt/backups/pre-deploy-$(date +%Y%m%d_%H%M%S).sql || echo "‚ö†Ô∏è Backup failed, continuing..."
            
            # Login to Docker Hub
            echo "üîê Logging into Docker Hub..."
            echo "${{ secrets.DOCKER_HUB_TOKEN }}" | docker login -u ${{ env.DOCKER_USERNAME }} --password-stdin
            
            # Pull latest images from Docker Hub
            echo "üì¶ Pulling latest images from Docker Hub..."
            docker pull ${{ env.STRAPI_IMAGE }}:latest
            docker pull ${{ env.NEXTJS_IMAGE }}:latest
            
            # Stop services
            echo "üõë Stopping services..."
            docker-compose down -v || true
            
            # Stop any existing nginx/apache using port 80
            echo "üîå Freeing up ports..."
            sudo systemctl stop nginx 2>/dev/null || true
            sudo systemctl stop apache2 2>/dev/null || true
            sudo fuser -k 80/tcp 2>/dev/null || true
            sudo fuser -k 443/tcp 2>/dev/null || true
            sudo fuser -k 8080/tcp 2>/dev/null || true
            
            # Start services with new images (uses docker-compose.yml which is docker-compose.prod.yml)
            echo "üöÄ Starting services with Docker Hub images..."
            docker-compose up -d
            
            # Wait for services to be healthy
            echo "‚è≥ Waiting for services to start..."
            sleep 30
            
            # Check if services are running
            if docker-compose ps | grep -q "Up"; then
              echo "‚úÖ Deployment successful!"
              docker-compose ps
            else
              echo "‚ùå Deployment failed!"
              docker-compose logs
              exit 1
            fi
            
            # Clean up old Docker images
            echo "üßπ Cleaning up old images..."
            docker image prune -f
            
            # Logout from Docker Hub
            docker logout
            
            echo "üéâ Deployment complete!"
          ENDSSH

      - name: Verify Deployment
        env:
          DROPLET_IP: ${{ secrets.DROPLET_IP }}
        run: |
          echo "üîç Verifying deployment..."
          echo "‚è≥ Waiting 60 seconds for Strapi to fully initialize..."
          sleep 60
          
          # Check if frontend is accessible
          if curl -f -s -o /dev/null http://$DROPLET_IP; then
            echo "‚úÖ Frontend is accessible"
          else
            echo "‚ùå Frontend is not accessible"
            exit 1
          fi
          
          # Check if Strapi admin is accessible (with retry)
          echo "üîç Checking Strapi admin..."
          for i in 1 2 3; do
            if curl -f -s -o /dev/null http://$DROPLET_IP/admin; then
              echo "‚úÖ Strapi admin is accessible"
              exit 0
            fi
            echo "‚è≥ Strapi not ready yet, retrying in 20 seconds... (attempt $i/3)"
            sleep 20
          done
          echo "‚ö†Ô∏è Strapi admin check timed out - containers are running, admin may need more time to initialize"
          echo "Check manually at: http://$DROPLET_IP/admin"

      - name: Deployment Summary
        if: success()
        run: |
          echo "üéâ Deployment completed successfully!"
          echo "Images deployed:"
          echo "  - Strapi: ${{ env.STRAPI_IMAGE }}:latest"
          echo "  - Next.js: ${{ env.NEXTJS_IMAGE }}:latest"
          echo "Access your application at: http://${{ secrets.DROPLET_IP }}"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo "Check the logs above for details."

